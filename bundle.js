(()=>{"use strict";var e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-40",headers:{authorization:"58e71842-fa9b-43bb-ae0e-cc1c7d460c64","Content-Type":"application/json"}},t=function(e){if(e.ok)return e.json();throw new Error("Ошибка сервера (".concat(e.status,"): ").concat(e.statusText))},n=function(e,n){return fetch(e,n).then(t).catch((function(e){throw e}))},r=function(t){return n("".concat(e.baseUrl,"/cards/").concat(t,"/likes"),{headers:e.headers,method:"PUT"})},o=function(t){return n("".concat(e.baseUrl,"/cards/").concat(t,"/likes"),{headers:e.headers,method:"DELETE"})},a=document.querySelector("#card-template");function c(e,t,n){var c=e.name,i=e.link,u=e.likes,s=e._id,l=e.owner,d=a.content.cloneNode(!0).firstElementChild,p=d.querySelector(".card__image"),f=d.querySelector(".card__title"),_=d.querySelector(".card__like-button"),m=d.querySelector(".card__delete-button"),v=d.querySelector(".card__like-counter");p.onerror=function(){return(e=d).classList.add("card__image-error"),void[".card__description",".card__like-counter"].forEach((function(t){var n=e.querySelector(t);n&&(n.style.display="none")}));var e},d.dataset.id=s,p.src=i,p.alt=c,f.textContent=c;var y,h,b=Array.isArray(u)?u.length:0;h=v,(y=b)>0?(h.textContent=y.toString(),h.classList.add("card__like-counter_is-active")):h.classList.add("hidden");var g=l._id===n;m.classList.toggle("card__delete-button_is-active",g);var S,L=(S=s,(JSON.parse(localStorage.getItem("likedCards"))||[]).includes(S));return _.classList.toggle("card__like-button_is-active",L),p.addEventListener("click",(function(){return t(i,c)})),_.addEventListener("click",(function(){return function(e,t,n){return new Promise((function(n){var a=t.classList.contains("card__like-button_is-active");(a?o:r)(e).then((function(){!function(e,t){var n=JSON.parse(localStorage.getItem("likedCards"))||[];t&&!n.includes(e)?n.push(e):n=n.filter((function(t){return t!==e})),localStorage.setItem("likedCards",JSON.stringify(n))}(e,!a),n(!a)})).catch((function(e){return console.error("Ошибка переключения лайка: ".concat(e))}))})).then((function(e){!function(e,t,n){e.classList.toggle("card__like-button_is-active",n),n?function(e){var t=Number(e.textContent)||0;e.textContent="".concat(t+1),e.classList.add("card__like-counter_is-active"),e.classList.remove("hidden")}(t):function(e){var t=Number(e.textContent)||0;t<=1?(e.textContent="",e.classList.add("hidden"),e.classList.remove("card__like-counter_is-active")):e.textContent="".concat(t-1)}(t)}(t,n,e)}))}(s,_,v)})),d}function i(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e&&(e.classList.add("popup_is-opened"),t&&e.classList.add(t),document.addEventListener("keydown",s))}function u(e){e&&e.classList.contains("popup_is-opened")&&(e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",s))}function s(e){if("Escape"===e.key){var t=document.querySelector(".popup.popup_is-opened");t&&u(t)}}function l(e,t){var n=Array.from(t.querySelectorAll(e.inputSelector)),r=t.querySelector(e.submitButtonSelector);function o(t){var n=t.nextElementSibling;n.textContent="",n.classList.remove(e.errorClass)}function a(){n.some((function(e){return!e.validity.valid}))?(r.classList.add(e.inactiveButtonClass),r.disabled=!0):(r.classList.remove(e.inactiveButtonClass),r.disabled=!1)}return{enableValidation:function(){n.forEach((function(t){t.addEventListener("input",(function(){t.validity.valid?o(t):function(t){var n=t.nextElementSibling,r="";t.validity.patternMismatch&&t.hasAttribute("data-error-message")&&(r=t.getAttribute("data-error-message"));var o=r||t.validationMessage;n.textContent=o,n.classList.add(e.inputErrorClass),n.classList.add(e.errorClass)}(t),a()}))})),a()},resetValidation:function(){n.forEach((function(e){o(e)})),a()},toggleButtonState:a}}function d(e,t){l(t,e).resetValidation()}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}var f,_={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__button",inactiveButtonClass:"popup__button_disabled",inputErrorClass:"popup__input_type_error",errorClass:"popup__error_visible"},m=document.querySelectorAll(".popup"),v=document.querySelector(".places__list"),y=document.querySelector(".popup.popup_type_edit"),h=document.querySelector(".popup.popup_type_new-card"),b=document.querySelector(".popup.popup_type_image"),g=b.querySelector(".popup__image"),S=b.querySelector(".popup__caption"),L=document.querySelector(".popup.popup_type_delete-confirm"),E=document.forms["edit-profile"],C=document.forms["new-place"],q=document.forms["change-avatar-form"],k=document.querySelector(".profile__title"),w=document.querySelector(".profile__description"),x=document.querySelector(".profile__image"),T=document.querySelector(".profile__edit-button"),A=document.querySelector(".profile__add-button");function I(e,t){g.src=e,g.alt=t,S.textContent=t,i(b)}Promise.all([n("".concat(e.baseUrl,"/users/me"),{headers:e.headers}),n("".concat(e.baseUrl,"/cards"),{headers:e.headers})]).then((function(t){var r,o,a=(o=2,function(e){if(Array.isArray(e))return e}(r=t)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,c,i=[],u=!0,s=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=a.call(n)).done)&&(i.push(r.value),i.length!==t);u=!0);}catch(e){s=!0,o=e}finally{try{if(!u&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(s)throw o}}return i}}(r,o)||function(e,t){if(e){if("string"==typeof e)return p(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(e,t):void 0}}(r,o)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),s=a[0],d=a[1];function f(e,t){e.disabled=t,e.classList.toggle("popup__button_disabled",t),e.textContent=t?"Сохранение...":"Сохранить"}window.currentUserId=s._id,function(e,t,n){e&&(k.textContent=e.name,w.textContent=e.about,e.avatar&&(x.style.backgroundImage="url(".concat(e.avatar,")"))),t.forEach((function(e){v.append(c(e,I,n))}))}(s,d,I,window.currentUserId),q.addEventListener("submit",(function(t){t.preventDefault();var r=t.currentTarget.elements.link.value.trim();if(r){var o=t.currentTarget.querySelector('.popup__button[type="submit"]');f(o,!0),setTimeout((function(){var t;(t=r,function(t){return n("".concat(e.baseUrl,"/users/me/avatar"),{headers:e.headers,method:"PATCH",body:JSON.stringify({avatar:t})})}(t).then((function(e){return{avatar:e.avatar,profileImage:x}}))).then((function(e){var t=e.avatar,n=e.profileImage;n&&(n.style.backgroundImage="url(".concat(t,")")),u(document.querySelector(".popup.popup_type_change-avatar")),f(o,!1)})).catch((function(e){console.error(e),f(o,!1)}))}),800)}})),E.addEventListener("submit",(function(t){t.preventDefault();var r=t.currentTarget.elements,o=r.name,a=r.description,c=t.currentTarget.querySelector('.popup__button[type="submit"]');f(c,!0);var i=o.value.trim(),s=a.value.trim();setTimeout((function(){(function(t){var r=t.name,o=t.about;return n("".concat(e.baseUrl,"/users/me"),{headers:e.headers,method:"PATCH",body:JSON.stringify({name:r,about:o})})})({name:i,about:s}).then((function(e){k.textContent=e.name,w.textContent=e.about,u(y),f(c,!1)})).catch((function(e){console.error(e),f(c,!1)}))}),800)})),C.addEventListener("submit",(function(t){t.preventDefault();var r=t.currentTarget.elements,o=r["place-name"],a=r.link,i=t.currentTarget.querySelector('.popup__button[type="submit"]');f(i,!0);var s=o.value.trim(),l=a.value.trim();s&&l&&setTimeout((function(){(function(t){var r=t.name,o=t.link;return n("".concat(e.baseUrl,"/cards"),{headers:e.headers,method:"POST",body:JSON.stringify({name:r,link:o})})})({name:s,link:l}).then((function(e){var t=c(e,I,window.currentUserId);v.prepend(t),u(h),f(i,!1)})).catch((function(e){console.error(e),f(i,!1)}))}),800)})),L.querySelector(".popup__button").addEventListener("click",(function(t){t.preventDefault();var r,o,a,c=L.dataset.cardId,i=document.querySelector('[data-id="'.concat(c,'"]'));c&&i&&(r=c,o=i,(a=r,n("".concat(e.baseUrl,"/cards/").concat(a),{headers:e.headers,method:"DELETE"})).then((function(){return o.remove()})).catch((function(e){return console.error(e)}))).then((function(){u(L)}))})),T.addEventListener("pointerdown",(function(){var e,t;e=k.textContent,t=w.textContent,E.name.value=e,E.description.value=t,l(_,E).toggleButtonState(),i(y)})),A.addEventListener("pointerdown",(function(){i(h)})),x.addEventListener("pointerdown",(function(){return i(document.querySelector(".popup.popup_type_change-avatar"))})),document.addEventListener("click",(function(e){if(e.target.classList.contains("card__delete-button")){var t=e.target.closest("[data-id]");if(t){var n=t.dataset.id;L.dataset.cardId=n,i(L)}}}))})).catch((function(e){console.error(e)})),m.forEach((function(e){e.addEventListener("pointerdown",(function(t){t.target===e&&(u(e),e.classList.contains("popup_type_change-avatar")&&(d(q,_),q.reset()),e.classList.contains("popup_type_new-card")&&(d(C,_),C.reset()),e.classList.contains("popup_type_edit")&&d(E,_))}));var t=e.querySelector(".popup__close");t&&t.addEventListener("pointerdown",(function(t){u(e),e.classList.contains("popup_type_change-avatar")&&(d(q,_),q.reset()),e.classList.contains("popup_type_new-card")&&(d(C,_),C.reset()),e.classList.contains("popup_type_edit")&&d(E,_)}))})),f=_,document.querySelectorAll(f.formSelector).forEach((function(e){l(f,e).enableValidation()}))})();